<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>プレイヤー振り分け（Last Z）</title>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg0:#07080b; --bg1:#0b0d12;
      --stroke: rgba(255,255,255,.12); --stroke2: rgba(255,255,255,.18);
      --text:#f3f5f7; --muted: rgba(243,245,247,.68);
      --silver:#cfd6de;
      --ok:#46e6a3; --warn:#ffb86b; --bad:#ff5a6a;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px; --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 25% 10%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 700px at 85% 30%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right)) max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
    }
    .app{ max-width: 1480px; margin: 0 auto; display:flex; flex-direction:column; gap:14px; }
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .brand h1{ margin:0; font-size: 18px; letter-spacing:.04em; font-weight: 780; }
    .brand .sub{ margin:0; color:var(--muted); font-size: 12px; line-height:1.35; max-width: 76ch; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      appearance:none; border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color:var(--text);
      padding:10px 12px; border-radius: 12px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      font-weight: 680; font-size: 13px; letter-spacing: .02em;
      display:inline-flex; align-items:center; gap:8px; user-select:none;
      box-shadow: 0 8px 28px rgba(0,0,0,.25);
      touch-action: manipulation;
    }
    .btn:hover{ transform: translateY(-1px); border-color: var(--stroke2); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }
    .btn.danger{ border-color: rgba(255,90,106,.35); background: linear-gradient(180deg, rgba(255,90,106,.14), rgba(255,255,255,.05)); }
    .btn.primary{ border-color: rgba(207,214,222,.35); background: linear-gradient(180deg, rgba(207,214,222,.20), rgba(255,255,255,.05)); }

    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; align-items:start; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.045));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.22); backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }
    .card .hd h2{
      margin:0; font-size: 13px; letter-spacing:.06em; font-weight: 780;
      color: var(--silver); text-transform: uppercase;
    }
    .card .bd{ padding:12px 14px; }

    .pill{
      font-family: var(--mono);
      font-size: 12px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: rgba(243,245,247,.85);
      white-space:nowrap;
    }

    /* Upload (mobile-safe) */
    .drop{
      border: 1px dashed rgba(207,214,222,.35);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
      position: relative;
      min-height: 64px;
    }
    .drop:hover{ border-color: rgba(207,214,222,.55); background: rgba(255,255,255,.05); }
    .drop.dragover{ border-color: rgba(207,214,222,.75); background: rgba(255,255,255,.06); }
    .drop .left{ display:flex; flex-direction:column; gap:4px; }
    .drop .title{ font-weight: 800; }
    .drop .hint{ color:var(--muted); font-size: 12px; }

    /* iOS対策: inputは完全hiddenにしない */
    #file{
      position:absolute;
      inset:0;
      opacity:0;
      width:100%;
      height:100%;
      cursor:pointer;
    }

    /* Progress */
    .progress{
      margin-top:10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:10px 12px;
      display:none;
      gap:10px;
    }
    .progress.show{ display:grid; }
    .pTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color: var(--muted); font-size: 12px;
    }
    .bar{
      height:10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(207,214,222,.90), rgba(255,255,255,.55));
      transition: width .15s ease;
    }
    .fill.sub{
      background: linear-gradient(90deg, rgba(70,230,163,.85), rgba(207,214,222,.55));
    }
    .mono{ font-family: var(--mono); }

    .status{
      margin-top:10px; display:none;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
    }
    .status.show{ display:block; }

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top:12px; margin-bottom: 10px;
    }
    .toolbar .left, .toolbar .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
      font-size: 13px;
      min-width: min(280px, 100%);
    }
    .input::placeholder{ color: rgba(243,245,247,.38); }

    .list{ display:flex; flex-direction:column; gap:10px; max-height: 56vh; overflow:auto; padding-right: 6px; }
    @media (min-width: 1101px){ .list{ max-height: 620px; } }

    .row{
      display:grid;
      grid-template-columns: 54px 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .row:hover{ transform: translateY(-1px); border-color: rgba(207,214,222,.26); background: rgba(255,255,255,.05); }
    .row.selected{ border-color: rgba(207,214,222,.55); background: rgba(207,214,222,.10); }
    .avatar{ width:54px; height:54px; border-radius: 14px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.04); object-fit: cover; }
    .meta{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .name{ font-weight: 860; letter-spacing:.02em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .stats{ display:flex; gap:8px; flex-wrap:wrap; color: var(--muted); font-size: 12px; align-items:center; }
    .tag{ border:1px solid var(--stroke); background: rgba(255,255,255,.04); padding:3px 8px; border-radius: 999px; font-family: var(--mono); font-size: 12px; color: rgba(243,245,247,.84); }
    .power{ font-family: var(--mono); font-weight: 900; letter-spacing:.02em; color: var(--silver); text-align:right; min-width: 96px; }
    @media (max-width: 420px){
      .row{ grid-template-columns: 48px 1fr; }
      .power{ grid-column: 2; text-align:left; min-width: unset; }
    }

    .groupForm{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      margin-bottom: 10px;
      align-items:center;
    }
    @media (max-width: 520px){
      .groupForm{ grid-template-columns: 1fr; }
      .groupForm .btn{ width:100%; justify-content:center; }
    }

    /* 6 colors only */
    .colors{ display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 12px; }
    .c{ width: 26px; height: 26px; border-radius: 999px; border:1px solid rgba(255,255,255,.18); cursor:pointer; position:relative; box-shadow: 0 8px 20px rgba(0,0,0,.25); }
    .c.sel::after{ content:""; position:absolute; inset:-3px; border-radius: 999px; border: 2px solid rgba(243,245,247,.85); filter: drop-shadow(0 6px 12px rgba(0,0,0,.35)); }

    .groups{ display:flex; flex-direction:column; gap:12px; max-height: 56vh; overflow:auto; padding-right: 6px; }
    @media (min-width: 1101px){ .groups{ max-height: 620px; } }

    .g{ border-radius: var(--radius2); border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); overflow:hidden; }
    .gHd{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-bottom:1px solid rgba(255,255,255,.10); flex-wrap:wrap; }
    .gTitle{ display:flex; align-items:center; gap:10px; min-width:0; }
    .dot{ width:10px; height:10px; border-radius: 999px; border:1px solid rgba(255,255,255,.25); }
    .gName{ font-weight: 860; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .gSub{ color: var(--muted); font-size: 12px; margin-top:2px; }
    .gBd{ padding:10px 12px; display:flex; flex-direction:column; gap:8px; }

    .m{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-radius: 12px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); }
    .mLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .mA{ width:34px; height:34px; border-radius: 10px; border:1px solid rgba(255,255,255,.14); object-fit: cover; background: rgba(255,255,255,.04); }
    .mName{ font-weight: 720; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .mRight{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .mini{ font-family: var(--mono); font-size: 12px; color: rgba(243,245,247,.82); }

    .ghost{
      color: var(--muted);
      font-size: 13px;
      padding: 22px 10px;
      text-align:center;
      border:1px dashed rgba(207,214,222,.22);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.02);
    }

    .captureWrap{
      margin-top: 12px;
      padding: 10px;
      border-radius: var(--radius2);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }
    .captureTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin: 0 0 8px 0;
      color: var(--muted);
      font-size: 12px;
      flex-wrap:wrap;
    }

    .log{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:10px 12px;
      color: rgba(243,245,247,.78);
      font-size: 12px;
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log.show{ display:block; }
    dialog::backdrop{ background: rgba(0,0,0,.65); }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <h1>プレイヤー振り分けツール（Last Z）</h1>
        <p class="sub">同盟メンバー画面のスクショをアップロード→「名前 / HQ / 戦力」を抽出→戦力順→グループ分け→画像出力。</p>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnExport" disabled>グループを画像で保存</button>
        <button class="btn danger" id="btnReset">全データ削除</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <h2>Players</h2>
          <div class="pill" id="pillCount">0 人</div>
        </div>
        <div class="bd">
          <div class="drop" id="drop" role="button" aria-label="画像アップロード">
            <input id="file" type="file" accept="image/*" multiple />
            <div class="left">
              <div class="title">同盟メンバー画面のスクショをアップロードしてください</div>
              <div class="hint">複数選択OK（HQ=城アイコン横 / 戦力=盾アイコン横）</div>
            </div>
            <div class="pill">タップして選択</div>
          </div>

          <div class="progress" id="progress">
            <div class="pTop">
              <div id="pLabel">準備中…</div>
              <div class="mono" id="pTime">開始: --:--:-- / 経過: 0.0s</div>
            </div>
            <div class="bar"><div class="fill" id="pAll"></div></div>
            <div class="pTop">
              <div id="pSubLabel">-</div>
              <div class="mono" id="pSubPct">0%</div>
            </div>
            <div class="bar"><div class="fill sub" id="pSub"></div></div>
          </div>

          <div class="status" id="status">待機中</div>
          <div class="log" id="log"></div>

          <div class="toolbar">
            <div class="left">
              <input class="input" id="q" placeholder="名前で検索…" />
            </div>
            <div class="right">
              <button class="btn" id="btnSelectNone" type="button">選択解除</button>
              <button class="btn" id="btnAssign" disabled type="button">選択中を追加…</button>
            </div>
          </div>

          <div class="list" id="playerList"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>Groups</h2>
          <div class="pill" id="pillGroup">0 グループ</div>
        </div>
        <div class="bd">
          <div class="groupForm">
            <input class="input" id="groupName" placeholder="グループ名（例：第一部隊）" />
            <button class="btn primary" id="btnCreate" type="button">グループ作成</button>
          </div>

          <div class="colors" id="colors"></div>

          <div class="captureWrap">
            <div class="captureTitle">
              <span>このエリアが画像出力されます</span>
              <span class="pill">PNG</span>
            </div>
            <div id="capture">
              <div class="groups" id="groupList"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <dialog id="dlg" style="border:none;border-radius:18px; padding:0; background: rgba(10,12,16,.95); color: var(--text); box-shadow: var(--shadow); width:min(560px, 92vw);">
      <div style="padding:16px 16px 12px; border-bottom:1px solid rgba(255,255,255,.12); display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-weight:850; letter-spacing:.02em;">追加先グループを選択</div>
        <button class="btn" id="btnClose" type="button">閉じる</button>
      </div>
      <div id="dlgBody" style="padding:14px 16px; display:flex; flex-direction:column; gap:10px;"></div>
    </dialog>
  </div>

<script>
  const LS_KEY = "lz_player_groups_v4";
  let state = load() ?? { players: [], groups: [], color: "#cfd6de", selected: new Set() };

  // 6色に削減（スマホで溢れない）
  const palette = ["#cfd6de","#ffffff","#9aa3ad","#ff5a6a","#46e6a3","#5aa9ff"];

  const $ = (s)=>document.querySelector(s);
  const drop = $("#drop");
  const file = $("#file");
  const statusEl = $("#status");
  const logEl = $("#log");

  const progressEl = $("#progress");
  const pLabel = $("#pLabel");
  const pTime = $("#pTime");
  const pAll = $("#pAll");
  const pSub = $("#pSub");
  const pSubLabel = $("#pSubLabel");
  const pSubPct = $("#pSubPct");

  const playerList = $("#playerList");
  const groupList = $("#groupList");
  const pillCount = $("#pillCount");
  const pillGroup = $("#pillGroup");
  const q = $("#q");

  const btnReset = $("#btnReset");
  const btnCreate = $("#btnCreate");
  const btnAssign = $("#btnAssign");
  const btnSelectNone = $("#btnSelectNone");
  const btnExport = $("#btnExport");

  const dlg = $("#dlg");
  const dlgBody = $("#dlgBody");
  const btnClose = $("#btnClose");

  let t0 = 0;
  let timerHandle = null;

  // Tesseract worker（使い回し）: 複数画像でcreate/terminateするのは非推奨 [page:1]
  let worker = null;
  let workerReady = false;

  renderPalette();
  renderAll();

  file.addEventListener("change", async (e)=> {
    const files = [...e.target.files];
    e.target.value = "";
    if(!files.length) return;
    await ingestFiles(files);
  });

  drop.addEventListener("dragover", (e)=>{ e.preventDefault(); drop.classList.add("dragover"); });
  drop.addEventListener("dragleave", ()=> drop.classList.remove("dragover"));
  drop.addEventListener("drop", async (e)=>{
    e.preventDefault(); drop.classList.remove("dragover");
    const files = [...e.dataTransfer.files].filter(f=>f.type.startsWith("image/"));
    if(!files.length) return;
    await ingestFiles(files);
  });

  q.addEventListener("input", ()=> renderPlayers());

  btnReset.addEventListener("click", ()=>{
    if(!confirm("全データ（プレイヤー/グループ）を削除します。よろしいですか？")) return;
    state = { players:[], groups:[], color:"#cfd6de", selected:new Set() };
    save();
    renderAll();
    setStatus("待機中", false);
    setLog("", false);
  });

  btnCreate.addEventListener("click", ()=>{
    const name = $("#groupName").value.trim();
    if(!name) return alert("グループ名を入力してください。");
    const g = { id: Date.now(), name, color: state.color, memberIds: [] };
    state.groups.unshift(g);
    $("#groupName").value = "";
    save();
    renderGroups();
  });

  btnSelectNone.addEventListener("click", ()=>{
    state.selected.clear();
    save();
    renderPlayers();
    syncButtons();
  });

  btnAssign.addEventListener("click", ()=>{
    if(state.selected.size === 0) return;
    if(state.groups.length === 0) return alert("先にグループを作成してください。");
    openAssignDialog();
  });

  btnClose.addEventListener("click", ()=> {
    if (typeof dlg.close === "function") dlg.close();
    else dlg.removeAttribute("open");
  });

  btnExport.addEventListener("click", async ()=>{
    if(state.groups.length === 0) return;
    const node = document.getElementById("capture");
    const scale = Math.min(2, (window.devicePixelRatio || 1));
    const canvas = await html2canvas(node, { backgroundColor: "#0b0d12", scale });
    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = `groups_${new Date().toISOString().slice(0,10)}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  async function ingestFiles(files){
    beginProgress();
    setStatus(`OCR準備中…（${files.length}枚）`, true);
    setLog("", false);

    try{
      await ensureWorker(); // workerを再利用してセットアップ時間削減 [page:1]
    }catch(e){
      endProgress();
      setStatus("OCR準備に失敗しました。", false);
      setLog(String(e?.message || e), true);
      return;
    }

    const startISO = new Date().toLocaleString();
    setLog(`開始: ${startISO}\n`, true);

    for(let i=0;i<files.length;i++){
      setOverall(i, files.length, `画像 ${i+1}/${files.length} を処理中…`);

      const dataUrl = await readAsDataURL(files[i]);

      // 前処理
      setSub(0.02, "前処理（2値化）…");
      const pre = await preprocessToDataURL(dataUrl);

      // OCR
      setSub(0.12, "OCR 実行中…（文字認識）");
      const tImgStart = performance.now();
      const { text, lastProgress } = await recognizeWithProgress(pre);
      const tImgEnd = performance.now();

      // 抽出
      setSub(0.92, "抽出（名前 / HQ / 戦力）…");
      const extracted = extractPlayersFromText(text);

      setLog(
        `\n---\n画像 ${i+1}/${files.length}\n` +
        `OCR時間: ${((tImgEnd - tImgStart)/1000).toFixed(1)}s\n` +
        `進捗最終: ${(lastProgress*100).toFixed(0)}%\n` +
        `抽出件数: ${extracted.length}\n` +
        `OCRテキスト（先頭300文字）:\n${text.slice(0,300)}\n`,
        true
      );

      if(extracted.length === 0){
        setStatus("抽出できませんでした（ログを確認してください）", false);
        continue;
      }

      // アイコンサムネ（ヒューリスティック）
      setSub(0.97, "アイコン切り出し（推定）…");
      const withIcons = await attachIconsHeuristic(extracted, dataUrl);

      // マージ＆ソート
      setSub(0.99, "一覧更新…");
      for(const p of withIcons){
        const exists = state.players.find(x => x.name === p.name);
        if(exists){
          if(p.power > exists.power){
            exists.power = p.power;
            exists.powerRaw = p.powerRaw;
          }
          exists.hq = p.hq ?? exists.hq;
          exists.iconDataUrl = p.iconDataUrl || exists.iconDataUrl;
        }else{
          state.players.push(p);
        }
      }
      state.players.sort((a,b)=> b.power - a.power);
      save();
      renderAll();
    }

    setOverall(files.length, files.length, "完了");
    setSub(1, "完了");
    setStatus("完了。", false);

    const endISO = new Date().toLocaleString();
    setLog(`\n終了: ${endISO}\n`, true);

    endProgress();
  }

  async function ensureWorker(){
    if(worker && workerReady) return;

    setSub(0.01, "OCRエンジン準備…");
    worker = await Tesseract.createWorker("eng+jpn", 1, {
      langPath: "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/lang-data"
    });

    await worker.setParameters({
      tessedit_char_whitelist:
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.-+_ぁあぃいぅうぇえぉおかがきぎくぐけげこごさざしじすずせぜそぞただちぢつづてでとどなにぬねのはばぱひびぴふぶぷへべぺほぼぽまみむめもやゆよらりるれろわをんー々ァアィイゥウェエォオカガキギクグケゲコゴサザシジスズセゼソゾタダチヂツヅテデトドナニヌネノハバパヒビピフブプヘベペホボポマミムメモヤユヨラリルレロワヲン・ 　"
    });

    // progress callback
    workerReady = true;
  }

  async function recognizeWithProgress(dataUrl){
    let last = 0;
    // Tesseract.js logger で進捗を取る（0..1のような値が来ることがある）
    const logger = m => {
      if(m && (m.progress ?? null) !== null && typeof m.progress === "number"){
        last = Math.max(last, m.progress);
        setSub(0.12 + (last * 0.78), `OCR 実行中… ${(last*100).toFixed(0)}%`);
      }
    };
    // set logger for this job
    if(worker.setLogger) worker.setLogger(logger);
    const { data } = await worker.recognize(dataUrl);
    return { text: data.text || "", lastProgress: last };
  }

  function extractPlayersFromText(text){
    const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
    const players = [];
    const seen = new Set();

    for(const line of lines){
      const powerMatch = line.match(/(\d{1,4}(?:\.\d{1,2})?)\s*([KMB])/i);
      if(!powerMatch) continue;

      const powerRaw = `${powerMatch[1]}${powerMatch[2].toUpperCase()}`;
      const power = parseCompactNumber(powerRaw);

      const hqCandidates = [...line.matchAll(/\b(\d{1,2})\b/g)].map(m=>parseInt(m[1],10));
      let hq = null;
      if(hqCandidates.length){
        const filtered = hqCandidates.filter(n => n > 0 && n <= 50);
        if(filtered.length) hq = filtered[filtered.length - 1];
      }

      let namePart = line;
      namePart = namePart.replace(powerMatch[0], " ");
      if(hq !== null) namePart = namePart.replace(new RegExp(`\\b${hq}\\b`), " ");
      namePart = namePart
        .replace(/\b(Online|ago|min|m|h)\b/gi," ")
        .replace(/[|•]/g," ")
        .replace(/\s+/g," ")
        .trim();

      const name = namePart.slice(0, 28).trim();
      if(name.length < 2) continue;

      if(seen.has(name)) continue;
      seen.add(name);

      players.push({
        id: Date.now() + Math.floor(Math.random()*1e6),
        name,
        hq: hq ?? 0,
        power,
        powerRaw,
        iconDataUrl: ""
      });
    }
    return players;
  }

  function parseCompactNumber(s){
    const m = String(s).toUpperCase().match(/(\d+(?:\.\d+)?)([KMB])/);
    if(!m) return 0;
    const n = parseFloat(m[1]);
    const u = m[2];
    const mult = u === "K" ? 1e3 : u === "M" ? 1e6 : 1e9;
    return Math.round(n * mult);
  }

  function formatCompact(n){
    if(n >= 1e9) return (n/1e9).toFixed(2)+"B";
    if(n >= 1e6) return (n/1e6).toFixed(1)+"M";
    if(n >= 1e3) return (n/1e3).toFixed(1)+"K";
    return String(n);
  }

  async function attachIconsHeuristic(players, fullDataUrl){
    const { canvas, w, h } = await dataUrlToCanvas(fullDataUrl);

    const out = [];
    const topOffset = Math.floor(h * 0.02);
    const rowH = Math.floor(h / 4.1);
    const colW = Math.floor(w / 2);
    const padX = Math.floor(w * 0.02);
    const padY = Math.floor(rowH * 0.18);
    const avatarSize = Math.floor(rowH * 0.62);

    for(let i=0;i<players.length;i++){
      const r = Math.floor(i/2);
      const c = i % 2;
      const x = c*colW + padX;
      const y = topOffset + r*rowH + padY;

      const crop = document.createElement("canvas");
      crop.width = avatarSize;
      crop.height = avatarSize;
      const ctx = crop.getContext("2d");
      ctx.drawImage(canvas, x, y, avatarSize, avatarSize, 0, 0, avatarSize, avatarSize);
      const iconDataUrl = crop.toDataURL("image/jpeg", 0.85);

      out.push({ ...players[i], iconDataUrl });
    }
    return out;
  }

  async function preprocessToDataURL(dataUrl){
    const { canvas } = await dataUrlToCanvas(dataUrl);
    const ctx = canvas.getContext("2d");
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const d = imgData.data;

    const threshold = 165;
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const gray = (0.299*r + 0.587*g + 0.114*b);
      const v = gray > threshold ? 255 : 0;
      d[i]=d[i+1]=d[i+2]=v;
    }
    ctx.putImageData(imgData,0,0);
    return canvas.toDataURL("image/png");
  }

  function beginProgress(){
    t0 = performance.now();
    progressEl.classList.add("show");
    setOverall(0,1,"準備中…");
    setSub(0,"-");
    timerHandle = setInterval(()=>{
      const sec = (performance.now() - t0)/1000;
      const now = new Date();
      pTime.textContent = `開始: ${now.toTimeString().slice(0,8)} / 経過: ${sec.toFixed(1)}s`;
    }, 120);
  }
  function endProgress(){
    if(timerHandle){ clearInterval(timerHandle); timerHandle = null; }
    // 表示は残す（状況把握のため）。消したければここでremove。
  }
  function setOverall(i, n, label){
    const pct = n ? (i/n) : 0;
    pAll.style.width = `${Math.max(0, Math.min(1, pct))*100}%`;
    pLabel.textContent = label;
  }
  function setSub(pct, label){
    const p = Math.max(0, Math.min(1, pct));
    pSub.style.width = `${p*100}%`;
    pSubLabel.textContent = label;
    pSubPct.textContent = `${Math.round(p*100)}%`;
  }

  function setStatus(msg, busy){
    statusEl.textContent = msg;
    statusEl.classList.add("show");
    statusEl.style.borderColor = busy ? "rgba(207,214,222,.22)" : "rgba(70,230,163,.25)";
  }
  function setLog(msg, show){
    if(msg) logEl.textContent += msg;
    logEl.classList.toggle("show", !!show);
  }

  function save(){
    const plain = { ...state, selected: [...state.selected] };
    localStorage.setItem(LS_KEY, JSON.stringify(plain));
  }
  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    obj.selected = new Set(obj.selected || []);
    return obj;
  }

  function renderPalette(){
    const wrap = $("#colors");
    wrap.innerHTML = palette.map(c=> `
      <div class="c ${state.color===c?"sel":""}" style="background:${c}" data-c="${c}" role="button" aria-label="色"></div>
    `).join("");
    [...wrap.querySelectorAll(".c")].forEach(el=>{
      el.addEventListener("click", ()=>{
        state.color = el.dataset.c;
        save();
        renderPalette();
      }, { passive: true });
    });
  }

  function renderAll(){
    renderPlayers();
    renderGroups();
    renderCounts();
    syncButtons();
  }
  function renderCounts(){
    pillCount.textContent = `${state.players.length} 人`;
    pillGroup.textContent = `${state.groups.length} グループ`;
  }
  function renderPlayers(){
    const query = q.value.trim().toLowerCase();
    const list = state.players
      .filter(p => !query || p.name.toLowerCase().includes(query))
      .sort((a,b)=> b.power - a.power);

    if(list.length === 0){
      playerList.innerHTML = `<div class="ghost">プレイヤーがまだいません。スクショをアップロードしてください。</div>`;
      return;
    }

    playerList.innerHTML = list.map(p=>{
      const sel = state.selected.has(p.id) ? "selected" : "";
      const icon = p.iconDataUrl || placeholderAvatar();
      return `
        <div class="row ${sel}" data-id="${p.id}">
          <img class="avatar" src="${icon}" alt="">
          <div class="meta">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="stats">
              <span class="tag">HQ ${p.hq ?? 0}</span>
              <span class="tag">戦力 ${escapeHtml(p.powerRaw || formatCompact(p.power))}</span>
            </div>
          </div>
          <div class="power">${formatCompact(p.power)}</div>
        </div>
      `;
    }).join("");

    [...playerList.querySelectorAll(".row")].forEach(el=>{
      el.addEventListener("click", ()=>{
        const id = Number(el.dataset.id);
        if(state.selected.has(id)) state.selected.delete(id);
        else state.selected.add(id);
        save();
        renderPlayers();
        syncButtons();
      }, { passive: true });
    });
  }
  function renderGroups(){
    if(state.groups.length === 0){
      groupList.innerHTML = `<div class="ghost">グループがまだありません。右上のフォームから作成してください。</div>`;
      btnExport.disabled = true;
      return;
    }

    groupList.innerHTML = state.groups.map(g=>{
      const members = g.memberIds.map(id=> state.players.find(p=>p.id===id)).filter(Boolean);
      const total = members.reduce((s,p)=> s + (p.power||0), 0);

      return `
        <div class="g">
          <div class="gHd">
            <div class="gTitle">
              <span class="dot" style="background:${g.color}"></span>
              <div style="min-width:0;">
                <div class="gName">${escapeHtml(g.name)}</div>
                <div class="gSub">${members.length}人 / 合計 ${formatCompact(total)}</div>
              </div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn" data-act="add" data-gid="${g.id}" type="button">追加</button>
              <button class="btn danger" data-act="del" data-gid="${g.id}" type="button">削除</button>
            </div>
          </div>
          <div class="gBd">
            ${members.length ? members.map(m=>{
              const icon = m.iconDataUrl || placeholderAvatar();
              return `
                <div class="m">
                  <div class="mLeft">
                    <img class="mA" src="${icon}" alt="">
                    <div style="min-width:0;">
                      <div class="mName">${escapeHtml(m.name)}</div>
                      <div class="gSub">HQ ${m.hq ?? 0} / 戦力 ${escapeHtml(m.powerRaw || formatCompact(m.power))}</div>
                    </div>
                  </div>
                  <div class="mRight">
                    <div class="mini">${formatCompact(m.power)}</div>
                    <button class="btn danger" data-act="rm" data-gid="${g.id}" data-pid="${m.id}" type="button">外す</button>
                  </div>
                </div>
              `;
            }).join("") : `<div class="ghost">メンバー未追加。左でプレイヤーを選択して「選択中を追加…」またはこのグループの「追加」から入れてください。</div>`}
          </div>
        </div>
      `;
    }).join("");

    [...groupList.querySelectorAll("button[data-act]")].forEach(b=>{
      b.addEventListener("click", ()=>{
        const act = b.dataset.act;
        const gid = Number(b.dataset.gid);

        if(act==="del"){
          if(!confirm("このグループを削除しますか？")) return;
          state.groups = state.groups.filter(x=>x.id!==gid);
          save(); renderGroups(); renderCounts(); syncButtons();
          return;
        }
        if(act==="add"){
          if(state.selected.size === 0) return alert("左の一覧から追加したいプレイヤーを選択してください。");
          addSelectedToGroup(gid);
          return;
        }
        if(act==="rm"){
          const pid = Number(b.dataset.pid);
          const g = state.groups.find(x=>x.id===gid);
          if(!g) return;
          g.memberIds = g.memberIds.filter(id=>id!==pid);
          save(); renderGroups(); syncButtons();
          return;
        }
      }, { passive: true });
    });

    btnExport.disabled = false;
  }
  function syncButtons(){
    btnAssign.disabled = state.selected.size === 0 || state.groups.length === 0;
    btnExport.disabled = state.groups.length === 0;
  }

  function openAssignDialog(){
    dlgBody.innerHTML = state.groups.map(g=> `
      <button class="btn primary" style="justify-content:space-between;" data-gid="${g.id}" type="button">
        <span style="display:flex;align-items:center;gap:10px;min-width:0;">
          <span class="dot" style="background:${g.color}"></span>
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(g.name)}</span>
        </span>
        <span class="pill">${g.memberIds.length}人</span>
      </button>
    `).join("");

    [...dlgBody.querySelectorAll("button[data-gid]")].forEach(b=>{
      b.addEventListener("click", ()=>{
        const gid = Number(b.dataset.gid);
        addSelectedToGroup(gid);
        if (typeof dlg.close === "function") dlg.close();
        else dlg.removeAttribute("open");
      });
    });

    // Safari fallback
    if (typeof dlg.showModal === "function") dlg.showModal();
    else dlg.setAttribute("open", "");
  }

  function addSelectedToGroup(gid){
    const g = state.groups.find(x=>x.id===gid);
    if(!g) return;
    for(const pid of state.selected){
      if(!g.memberIds.includes(pid)) g.memberIds.push(pid);
    }
    state.selected.clear();
    save();
    renderPlayers();
    renderGroups();
    syncButtons();
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function readAsDataURL(f){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=> res(r.result);
      r.onerror = rej;
      r.readAsDataURL(f);
    });
  }
  function dataUrlToCanvas(dataUrl){
    return new Promise((res)=>{
      const img = new Image();
      img.onload = ()=>{
        const c = document.createElement("canvas");
        c.width = img.naturalWidth;
        c.height = img.naturalHeight;
        c.getContext("2d").drawImage(img, 0, 0);
        res({ canvas: c, w: c.width, h: c.height });
      };
      img.src = dataUrl;
    });
  }
  function placeholderAvatar(){
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120">
      <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#1b1e28"/><stop offset="1" stop-color="#0b0d12"/>
      </linearGradient></defs>
      <rect width="120" height="120" rx="22" fill="url(#g)"/>
      <circle cx="60" cy="48" r="18" fill="#cfd6de" opacity=".55"/>
      <rect x="28" y="74" width="64" height="26" rx="13" fill="#cfd6de" opacity=".35"/>
    </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }
</script>
</body>
</html>
