<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Last Z Tool (Smart Name Cleaner)</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{ --bg:#0b0d12; --text:#f3f5f7; --accent:#46e6a3; --err:#ff5a6a; --mono:monospace; }
    body{ background:var(--bg); color:var(--text); font-family:system-ui,sans-serif; margin:0; padding:14px; }
    .app{ max-width:1200px; margin:0 auto; display:flex; flex-direction:column; gap:14px; }
    .card{ background:#161920; border:1px solid #333; border-radius:12px; padding:14px; }
    .btn{ background:#252932; border:1px solid #444; color:white; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .btn.primary{ background: #2a3e55; border-color:#5aa9ff; }
    .log{ background:#000; padding:10px; font-family:var(--mono); font-size:12px; color:#aaa; white-space:pre-wrap; max-height:200px; overflow:auto; }
    .debug-img{ max-width:100%; border:2px solid var(--accent); margin-top:10px; display:none; }
    .controls{ display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-bottom:12px; background:#1f232c; padding:10px; border-radius:8px; }
    label{ display:flex; align-items:center; gap:6px; font-size:13px; font-weight:bold; cursor:pointer; }
    select, input[type=number] { background:#000; border:1px solid #444; color:white; padding:4px; border-radius:4px; }
    input[type=checkbox] { width:18px; height:18px; }
    .g{ border:1px solid #333; background:#1a1d24; border-radius:8px; margin-bottom:10px; overflow:hidden; }
    .gHd{ padding:8px 12px; background:#252932; display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
<div class="app">
  <h1>Last Z Tool (Smart Name Cleaner)</h1>

  <div class="card">
    <div class="controls">
      <label>Layout: 
        <select id="cfgLayout">
          <option value="1">1 Column (Default)</option>
          <option value="2">2 Columns</option>
        </select>
      </label>
      <label><input type="checkbox" id="cfgInvert" checked> Invert Colors (Fixes white text)</label>
      <label>Start Y%: <input type="number" id="cfgTop" value="18" style="width:50px"></label>
      <label>End Y%: <input type="number" id="cfgBot" value="92" style="width:50px"></label>
    </div>

    <input type="file" id="file" accept="image/*" multiple style="margin-bottom:10px; display:block; width:100%; padding:20px; border:2px dashed #444; border-radius:8px; text-align:center;">
    
    <div id="status" style="margin-bottom:10px; color:var(--accent);">Ready</div>
    
    <button class="btn" onclick="toggleDebug()">Toggle Debug Image</button>
    <div id="debugContainer"></div>
    <div class="log" id="log">Logs...</div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <b>Players (<span id="count">0</span>)</b>
      <button class="btn" id="btnExport">Export Groups Image</button>
    </div>
    <div id="list"></div>
  </div>
  
  <div class="card" id="capture">
    <b>Groups Preview</b>
    <div id="groups"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
let state = { players: [] };
let busy = false;

$('#file').addEventListener('change', async e => {
  if(busy) return;
  const files = [...e.target.files];
  e.target.value = "";
  if(!files.length) return;
  
  busy = true;
  $('#status').innerText = "Processing...";
  $('#debugContainer').innerHTML = ""; 

  for(const f of files){
    try { await processImage(f); } catch(err) { log("Error: " + err.message); }
  }
  
  render();
  $('#status').innerText = "Done.";
  busy = false;
});

$('#btnExport').onclick = async () => {
  const canvas = await html2canvas($('#capture'), { backgroundColor:"#0b0d12" });
  const a = document.createElement('a');
  a.href = canvas.toDataURL();
  a.download = "groups.png";
  a.click();
};

function toggleDebug(){
  const imgs = document.querySelectorAll('.debug-img');
  imgs.forEach(img => img.style.display = img.style.display === 'none' ? 'block' : 'none');
}

async function processImage(file){
  const cfg = {
    layout: $('#cfgLayout').value,
    invert: $('#cfgInvert').checked,
    top: Number($('#cfgTop').value) / 100,
    bot: Number($('#cfgBot').value) / 100
  };
  
  const dataUrl = await readAsDataURL(file);
  const { canvas, blobUrl } = await preprocess(dataUrl, cfg);
  
  const img = document.createElement('img');
  img.src = blobUrl;
  img.className = 'debug-img';
  $('#debugContainer').appendChild(img);

  log(`OCR running...`);
  const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
    tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
    tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.-_ KMBkmb' // RESTRICT CHARS
  });

  const lines = text.split('\n');
  let count = 0;
  
  for(const line of lines){
    // Look for power (Number + K/M/B)
    const m = line.match(/(\d{1,5}(?:\.\d{1,2})?)\s*([KMBkmb])/);
    if(!m) continue;
    
    const powerStr = m[0].toUpperCase();
    const powerVal = parsePower(m[1], m[2]);
    
    // RAW NAME: Everything before the power
    let rawName = line.substring(0, m.index).trim();
    
    // === SMART CLEANER ===
    // 1. Remove common OCR garbage from icons (single chars, brackets)
    // e.g., "e NEXUS" -> "NEXUS", "| NEXUS" -> "NEXUS"
    let cleanName = rawName.replace(/^[^a-zA-Z0-9]{1,3}\s+/, ""); 
    
    // 2. Keep only valid username characters (Alphanumeric + . - _)
    cleanName = cleanName.replace(/[^a-zA-Z0-9_\- .]/g, "");
    
    // 3. Trim again
    cleanName = cleanName.trim();
    
    // 4. Min length check
    if(cleanName.length < 3) continue; 

    if(!state.players.some(p => p.name === cleanName)){
      state.players.push({ id: Date.now()+Math.random(), name: cleanName, power: powerVal, powerStr });
      count++;
    }
  }
  log(`Extracted ${count} players.`);
}

async function preprocess(dataUrl, cfg){
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const w = img.width;
      const h = img.height;
      const y1 = Math.floor(h * cfg.top);
      const hROI = Math.floor(h * cfg.bot) - y1;
      
      const can = document.createElement('canvas');
      const ctx = can.getContext('2d');
      
      can.width = w * 2;
      can.height = hROI * 2;
      ctx.imageSmoothingEnabled = false;
      
      ctx.drawImage(img, 0, y1, w, hROI, 0, 0, can.width, can.height);
      
      const idata = ctx.getImageData(0,0, can.width, can.height);
      const d = idata.data;
      
      for(let i=0; i<d.length; i+=4){
        const r=d[i], g=d[i+1], b=d[i+2];
        let gray = 0.299*r + 0.587*g + 0.114*b;
        if(cfg.invert) gray = 255 - gray;
        gray = gray > 145 ? 255 : 0; // Hard threshold to clean noise
        d[i] = d[i+1] = d[i+2] = gray;
      }
      
      ctx.putImageData(idata, 0, 0);
      resolve({ canvas: can, blobUrl: can.toDataURL() });
    };
    img.src = dataUrl;
  });
}

function parsePower(num, unit){
  let n = parseFloat(num);
  const u = unit.toUpperCase();
  if(u === 'K') n *= 1000;
  if(u === 'M') n *= 1000000;
  if(u === 'B') n *= 1000000000;
  return n;
}

function render(){
  state.players.sort((a,b) => b.power - a.power);
  $('#count').innerText = state.players.length;
  
  // Auto Group Logic (Just chunks for now)
  const groups = [];
  const chunkSize = 10;
  for (let i = 0; i < state.players.length; i += chunkSize) {
      groups.push(state.players.slice(i, i + chunkSize));
  }
  
  $('#groups').innerHTML = groups.map((g, i) => `
    <div class="g">
      <div class="gHd" style="color:#aaa; font-size:12px">Group ${i+1} (${g.length})</div>
      <div style="padding:10px">
        ${g.map(p => `
          <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:4px 0;">
            <b>${p.name}</b> <span>${p.powerStr}</span>
          </div>`).join('')}
      </div>
    </div>
  `).join('');
}

function readAsDataURL(f){
  return new Promise(r => { const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); });
}
function log(s){ $('#log').innerText += s + "\n"; }
</script>
</body>
</html>
