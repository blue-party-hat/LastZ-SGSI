<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Last Z Grouping (Debug Mode)</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{ --bg:#0b0d12; --text:#f3f5f7; --accent:#46e6a3; --err:#ff5a6a; --mono:monospace; }
    body{ background:var(--bg); color:var(--text); font-family:system-ui,sans-serif; margin:0; padding:14px; }
    .app{ max-width:1200px; margin:0 auto; display:flex; flex-direction:column; gap:14px; }
    .card{ background:#161920; border:1px solid #333; border-radius:12px; padding:14px; }
    .btn{ background:#252932; border:1px solid #444; color:white; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:bold; }
    .btn.primary{ background: #2a3e55; border-color:#5aa9ff; }
    .btn.danger{ border-color:var(--err); color:var(--err); }
    .row{ display:flex; gap:10px; align-items:center; padding:8px; border-bottom:1px solid #222; }
    .log{ background:#000; padding:10px; font-family:var(--mono); font-size:12px; color:#aaa; white-space:pre-wrap; max-height:200px; overflow:auto; }
    .debug-img{ max-width:100%; border:2px solid var(--accent); margin-top:10px; display:none; }
    .controls{ display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-bottom:12px; background:#1f232c; padding:10px; border-radius:8px; }
    label{ display:flex; align-items:center; gap:6px; font-size:13px; font-weight:bold; cursor:pointer; }
    select, input[type=number] { background:#000; border:1px solid #444; color:white; padding:4px; border-radius:4px; }
    input[type=checkbox] { width:18px; height:18px; }
    .avatar{ width:40px; height:40px; border-radius:6px; background:#222; object-fit:cover; }
    .g{ border:1px solid #333; background:#1a1d24; border-radius:8px; margin-bottom:10px; overflow:hidden; }
    .gHd{ padding:8px 12px; background:#252932; display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
<div class="app">
  <h1>Last Z Tool (Debug Version)</h1>

  <div class="card">
    <div class="controls">
      <label>Layout: 
        <select id="cfgLayout">
          <option value="1">1 Column (Safe)</option>
          <option value="2">2 Columns</option>
        </select>
      </label>
      <label><input type="checkbox" id="cfgInvert" checked> Invert Colors (Fixes white text)</label>
      <label>Start Y%: <input type="number" id="cfgTop" value="18" style="width:50px"></label>
      <label>End Y%: <input type="number" id="cfgBot" value="92" style="width:50px"></label>
    </div>

    <input type="file" id="file" accept="image/*" multiple style="margin-bottom:10px; display:block; width:100%; padding:20px; border:2px dashed #444; border-radius:8px; text-align:center;">
    
    <div id="status" style="margin-bottom:10px; color:var(--accent);">Ready</div>
    
    <button class="btn" onclick="toggleDebug()">Show/Hide What OCR Sees</button>
    <div id="debugContainer"></div>
    
    <div class="log" id="log">Logs will appear here...</div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <b>Players (<span id="count">0</span>)</b>
      <div style="display:flex; gap:10px;">
         <button class="btn danger" id="btnReset">Reset</button>
         <button class="btn" id="btnExport">Export Groups</button>
      </div>
    </div>
    <div id="list"></div>
  </div>
  
  <div class="card" id="capture">
    <b>Groups</b> (Create in console if needed, for now auto-groups by power)
    <div id="groups"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
let state = { players: [] };
let busy = false;

// Config
const getCfg = () => ({
  layout: $('#cfgLayout').value,
  invert: $('#cfgInvert').checked,
  top: Number($('#cfgTop').value) / 100,
  bot: Number($('#cfgBot').value) / 100
});

$('#file').addEventListener('change', async e => {
  if(busy) return;
  const files = [...e.target.files];
  e.target.value = "";
  if(!files.length) return;
  
  busy = true;
  $('#status').innerText = "Processing...";
  $('#debugContainer').innerHTML = ""; // clear old debug images

  for(const f of files){
    try {
      await processImage(f);
    } catch(err) {
      log("Error: " + err.message);
    }
  }
  
  render();
  $('#status').innerText = "Done.";
  busy = false;
});

$('#btnReset').onclick = () => { state.players = []; render(); };
$('#btnExport').onclick = async () => {
  const canvas = await html2canvas($('#capture'), { backgroundColor:"#0b0d12" });
  const a = document.createElement('a');
  a.href = canvas.toDataURL();
  a.download = "groups.png";
  a.click();
};

function toggleDebug(){
  const imgs = document.querySelectorAll('.debug-img');
  imgs.forEach(img => img.style.display = img.style.display === 'none' ? 'block' : 'none');
}

async function processImage(file){
  const cfg = getCfg();
  const dataUrl = await readAsDataURL(file);
  
  // 1. Preprocess (Crop -> Invert -> Scale)
  const { canvas, blobUrl } = await preprocess(dataUrl, cfg);
  
  // Debug: Show image
  const img = document.createElement('img');
  img.src = blobUrl;
  img.className = 'debug-img';
  $('#debugContainer').appendChild(img);

  // 2. OCR
  log(`OCR running... (Layout: ${cfg.layout} Col)`);
  const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
    tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT, // Works well for lists
  });

  log(`OCR Result (First 100 chars):\n${text.slice(0, 100).replace(/\n/g, ' ')}...`);

  // 3. Extract
  const lines = text.split('\n');
  let count = 0;
  
  for(const line of lines){
    // Regex: Look for number followed by K, M, or B (case insensitive)
    // Relaxed regex to catch "1.2 M" or "100k"
    const m = line.match(/(\d{1,5}(?:\.\d{1,2})?)\s*([KMBkmb])/);
    if(!m) continue;
    
    const powerStr = m[0].toUpperCase();
    const powerVal = parsePower(m[1], m[2]);
    
    // Name is everything before the power
    let name = line.substring(0, m.index).trim();
    
    // Filter noise
    name = name.replace(/[^a-zA-Z0-9_\- .]/g, ""); 
    if(name.length < 2) continue;

    if(!state.players.some(p => p.name === name)){
      state.players.push({ id: Date.now()+Math.random(), name, power: powerVal, powerStr });
      count++;
    }
  }
  log(`Extracted ${count} players.`);
}

async function preprocess(dataUrl, cfg){
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const w = img.width;
      const h = img.height;
      
      // ROI Calc
      const y1 = Math.floor(h * cfg.top);
      const hROI = Math.floor(h * cfg.bot) - y1;
      
      // Create canvas for processing
      const can = document.createElement('canvas');
      const ctx = can.getContext('2d');
      
      // Scale up 2x for better OCR
      can.width = w * 2;
      can.height = hROI * 2;
      
      ctx.imageSmoothingEnabled = false; // pixel art style scaling usually better for hard edges
      
      // Draw cropped area scaled up
      ctx.drawImage(img, 0, y1, w, hROI, 0, 0, can.width, can.height);
      
      // Pixel manipulation (Invert + Grayscale)
      const idata = ctx.getImageData(0,0, can.width, can.height);
      const d = idata.data;
      
      for(let i=0; i<d.length; i+=4){
        const r=d[i], g=d[i+1], b=d[i+2];
        let gray = 0.299*r + 0.587*g + 0.114*b;
        
        if(cfg.invert) gray = 255 - gray; // Invert: Dark bg -> Light bg
        
        // Thresholding (make it purely black/white) - often helps Tesseract
        gray = gray > 160 ? 255 : 0; 

        d[i] = d[i+1] = d[i+2] = gray;
      }
      
      ctx.putImageData(idata, 0, 0);
      
      resolve({ canvas: can, blobUrl: can.toDataURL() });
    };
    img.src = dataUrl;
  });
}

function parsePower(num, unit){
  let n = parseFloat(num);
  const u = unit.toUpperCase();
  if(u === 'K') n *= 1000;
  if(u === 'M') n *= 1000000;
  if(u === 'B') n *= 1000000000;
  return n;
}

function render(){
  // Sort by power
  state.players.sort((a,b) => b.power - a.power);
  $('#count').innerText = state.players.length;
  
  $('#list').innerHTML = state.players.map(p => `
    <div class="row">
      <img class="avatar" src="https://ui-avatars.com/api/?name=${p.name}&background=random&color=fff">
      <div style="flex:1">
        <div style="font-weight:bold">${p.name}</div>
        <div style="font-size:12px; opacity:0.7">Power: ${p.powerStr}</div>
      </div>
    </div>
  `).join('');
  
  // Auto grouping for demo (Top 10, next 10...)
  const groups = [];
  const chunkSize = 10;
  for (let i = 0; i < state.players.length; i += chunkSize) {
      const chunk = state.players.slice(i, i + chunkSize);
      groups.push(chunk);
  }
  
  $('#groups').innerHTML = groups.map((g, i) => `
    <div class="g">
      <div class="gHd" style="color:#aaa; font-size:12px">Group ${i+1} (${g.length})</div>
      <div style="padding:10px">
        ${g.map(p => `<div>${p.name} <span style="float:right; opacity:0.5">${p.powerStr}</span></div>`).join('')}
      </div>
    </div>
  `).join('');
}

function readAsDataURL(f){
  return new Promise(r => { const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); });
}
function log(s){ $('#log').innerText += s + "\n"; }
</script>
</body>
</html>
