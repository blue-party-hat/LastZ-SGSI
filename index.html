<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>プレイヤー振り分け（Last Z）</title>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg0:#07080b; --bg1:#0b0d12;
      --stroke: rgba(255,255,255,.12); --stroke2: rgba(255,255,255,.18);
      --text:#f3f5f7; --muted: rgba(243,245,247,.68);
      --silver:#cfd6de;
      --ok:#46e6a3; --bad:#ff5a6a;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px; --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 25% 10%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 700px at 85% 30%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right)) max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
    }
    .app{ max-width: 1480px; margin: 0 auto; display:flex; flex-direction:column; gap:14px; }
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .brand h1{ margin:0; font-size: 18px; letter-spacing:.04em; font-weight: 780; }
    .brand .sub{ margin:0; color:var(--muted); font-size: 12px; line-height:1.35; max-width: 76ch; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      appearance:none; border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color:var(--text);
      padding:10px 12px; border-radius: 12px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      font-weight: 680; font-size: 13px; letter-spacing: .02em;
      display:inline-flex; align-items:center; gap:8px; user-select:none;
      box-shadow: 0 8px 28px rgba(0,0,0,.25);
      touch-action: manipulation;
    }
    .btn:hover{ transform: translateY(-1px); border-color: var(--stroke2); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }
    .btn.danger{ border-color: rgba(255,90,106,.35); background: linear-gradient(180deg, rgba(255,90,106,.14), rgba(255,255,255,.05)); }
    .btn.primary{ border-color: rgba(207,214,222,.35); background: linear-gradient(180deg, rgba(207,214,222,.20), rgba(255,255,255,.05)); }

    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; align-items:start; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.045));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.22); backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }
    .card .hd h2{
      margin:0; font-size: 13px; letter-spacing:.06em; font-weight: 780;
      color: var(--silver); text-transform: uppercase;
    }
    .card .bd{ padding:12px 14px; }

    .pill{
      font-family: var(--mono);
      font-size: 12px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: rgba(243,245,247,.85);
      white-space:nowrap;
    }

    .drop{
      border: 1px dashed rgba(207,214,222,.35);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position: relative;
      min-height: 64px;
    }
    .drop .left{ display:flex; flex-direction:column; gap:4px; }
    .drop .title{ font-weight: 800; }
    .drop .hint{ color:var(--muted); font-size: 12px; }
    #file{ position:absolute; inset:0; opacity:0; width:100%; height:100%; cursor:pointer; }

    .progress{
      margin-top:10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:10px 12px;
      display:none;
      gap:10px;
    }
    .progress.show{ display:grid; }
    .pTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; color: var(--muted); font-size: 12px; }
    .bar{ height:10px; border-radius: 999px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.20); overflow:hidden; }
    .fill{ height:100%; width:0%; background: linear-gradient(90deg, rgba(207,214,222,.90), rgba(255,255,255,.55)); transition: width .15s ease; }
    .fill.sub{ background: linear-gradient(90deg, rgba(70,230,163,.85), rgba(207,214,222,.55)); }
    .mono{ font-family: var(--mono); }

    .status{
      margin-top:10px; display:none;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
    }
    .status.show{ display:block; }

    .log{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:10px 12px;
      color: rgba(243,245,247,.78);
      font-size: 12px;
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log.show{ display:block; }

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top:12px; margin-bottom: 10px;
    }
    .toolbar .left, .toolbar .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
      font-size: 13px;
      min-width: min(280px, 100%);
    }
    .input::placeholder{ color: rgba(243,245,247,.38); }

    .list{ display:flex; flex-direction:column; gap:10px; max-height: 56vh; overflow:auto; padding-right: 6px; }

    .row{
      display:grid;
      grid-template-columns: 54px 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
    }
    .row.selected{ border-color: rgba(207,214,222,.55); background: rgba(207,214,222,.10); }
    .avatar{ width:54px; height:54px; border-radius: 14px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.04); object-fit: cover; }
    .meta{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .name{ font-weight: 860; letter-spacing:.02em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .stats{ display:flex; gap:8px; flex-wrap:wrap; color: var(--muted); font-size: 12px; align-items:center; }
    .tag{ border:1px solid var(--stroke); background: rgba(255,255,255,.04); padding:3px 8px; border-radius: 999px; font-family: var(--mono); font-size: 12px; color: rgba(243,245,247,.84); }
    .power{ font-family: var(--mono); font-weight: 900; letter-spacing:.02em; color: var(--silver); text-align:right; min-width: 96px; }

    .groupForm{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      margin-bottom: 10px;
      align-items:center;
    }
    @media (max-width: 520px){
      .groupForm{ grid-template-columns: 1fr; }
      .groupForm .btn{ width:100%; justify-content:center; }
    }

    .colors{ display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 12px; }
    .c{ width: 26px; height: 26px; border-radius: 999px; border:1px solid rgba(255,255,255,.18); cursor:pointer; position:relative; box-shadow: 0 8px 20px rgba(0,0,0,.25); }
    .c.sel::after{ content:""; position:absolute; inset:-3px; border-radius: 999px; border: 2px solid rgba(243,245,247,.85); }

    .groups{ display:flex; flex-direction:column; gap:12px; max-height: 56vh; overflow:auto; padding-right: 6px; }

    .g{ border-radius: var(--radius2); border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); overflow:hidden; }
    .gHd{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-bottom:1px solid rgba(255,255,255,.10); flex-wrap:wrap; }
    .gTitle{ display:flex; align-items:center; gap:10px; min-width:0; }
    .dot{ width:10px; height:10px; border-radius: 999px; border:1px solid rgba(255,255,255,.25); }
    .gName{ font-weight: 860; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .gSub{ color: var(--muted); font-size: 12px; margin-top:2px; }
    .gBd{ padding:10px 12px; display:flex; flex-direction:column; gap:8px; }
    .gRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .gRow .left{ min-width:0; display:flex; flex-direction:column; gap:2px; }
    .gRow .nm{ font-weight: 820; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .gRow .sm{ color:var(--muted); font-size:12px; font-family: var(--mono); }
    .gRow .pw{ font-family: var(--mono); font-weight: 900; }

    .ghost{
      color: var(--muted);
      font-size: 13px;
      padding: 22px 10px;
      text-align:center;
      border:1px dashed rgba(207,214,222,.22);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.02);
    }

    .captureWrap{
      margin-top: 12px;
      padding: 10px;
      border-radius: var(--radius2);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }
    .captureTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin: 0 0 8px 0;
      color: var(--muted);
      font-size: 12px;
      flex-wrap:wrap;
    }

    dialog::backdrop{ background: rgba(0,0,0,.65); }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <h1>プレイヤー振り分けツール（Last Z）</h1>
        <p class="sub">スクショを選択→端末内でOCR→戦力順で一覧→グループ分け→画像保存。</p>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnExport" disabled type="button">グループを画像で保存</button>
        <button class="btn danger" id="btnReset" type="button">全データ削除</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <h2>Players</h2>
          <div class="pill" id="pillCount">0 人</div>
        </div>
        <div class="bd">
          <div class="drop" id="drop">
            <input id="file" type="file" accept="image/*" multiple />
            <div class="left">
              <div class="title" id="dropTitle">同盟メンバー画面のスクショを選択してください</div>
              <div class="hint" id="dropHint">複数選択OK</div>
            </div>
            <div class="pill" id="pickHint">タップして選択</div>
          </div>

          <div class="progress" id="progress">
            <div class="pTop">
              <div id="pLabel">準備中…</div>
              <div class="mono" id="pTime">開始: --:--:-- / 経過: 0.0s</div>
            </div>
            <div class="bar"><div class="fill" id="pAll"></div></div>
            <div class="pTop">
              <div id="pSubLabel">-</div>
              <div class="mono" id="pSubPct">0%</div>
            </div>
            <div class="bar"><div class="fill sub" id="pSub"></div></div>
          </div>

          <div class="status" id="status">待機中</div>
          <div class="log" id="log"></div>

          <div class="toolbar">
            <div class="left">
              <input class="input" id="q" placeholder="名前で検索…" />
            </div>
            <div class="right">
              <button class="btn" id="btnSelectNone" type="button">選択解除</button>
              <button class="btn" id="btnAssign" disabled type="button">選択中を追加…</button>
            </div>
          </div>

          <div class="list" id="playerList"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>Groups</h2>
          <div class="pill" id="pillGroup">0 グループ</div>
        </div>
        <div class="bd">
          <div class="groupForm">
            <input class="input" id="groupName" placeholder="グループ名（例：第一部隊）" />
            <button class="btn primary" id="btnCreate" type="button">グループ作成</button>
          </div>

          <div class="colors" id="colors"></div>

          <div class="captureWrap">
            <div class="captureTitle">
              <span>このエリアが画像出力されます</span>
              <span class="pill">PNG</span>
            </div>
            <div id="capture">
              <div class="groups" id="groupList"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <dialog id="dlg" style="border:none;border-radius:18px; padding:0; background: rgba(10,12,16,.95); color: var(--text); box-shadow: var(--shadow); width:min(560px, 92vw);">
      <div style="padding:16px 16px 12px; border-bottom:1px solid rgba(255,255,255,.12); display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-weight:850; letter-spacing:.02em;">追加先グループを選択</div>
        <button class="btn" id="btnClose" type="button">閉じる</button>
      </div>
      <div id="dlgBody" style="padding:14px 16px; display:flex; flex-direction:column; gap:10px;"></div>
    </dialog>
  </div>

<script>
  // ===== OCR tuning (English usernames) =====
  // PSM tuning can change results dramatically [web:184][web:183]
  const PSM_MODE = Tesseract.PSM?.SINGLE_BLOCK ?? 6; // SINGLE_BLOCK ~= 6 [web:184]
  // Disabling dictionaries helps for non-words/usernames [web:153]
  const OCR_PARAMS = {
    tessedit_pageseg_mode: PSM_MODE,
    load_system_dawg: "0",
    load_freq_dawg: "0"
  };

  const LS_KEY = "lz_player_groups_full_groups_enabled";
  let state = load() ?? { players: [], groups: [], color: "#46e6a3", selected: new Set() };

  const palette = ["#ff5a6a","#ffb86b","#fee140","#46e6a3","#5aa9ff","#c471f5"];

  const $ = (s)=>document.querySelector(s);
  const file = $("#file");
  const statusEl = $("#status");
  const logEl = $("#log");

  const progressEl = $("#progress");
  const pLabel = $("#pLabel");
  const pTime = $("#pTime");
  const pAll = $("#pAll");
  const pSub = $("#pSub");
  const pSubLabel = $("#pSubLabel");
  const pSubPct = $("#pSubPct");

  const playerList = $("#playerList");
  const groupList = $("#groupList");
  const pillCount = $("#pillCount");
  const pillGroup = $("#pillGroup");
  const q = $("#q");

  const btnReset = $("#btnReset");
  const btnCreate = $("#btnCreate");
  const btnAssign = $("#btnAssign");
  const btnSelectNone = $("#btnSelectNone");
  const btnExport = $("#btnExport");

  const dlg = $("#dlg");
  const dlgBody = $("#dlgBody");
  const btnClose = $("#btnClose");

  let busy = false;
  let t0 = 0;
  let timerHandle = null;

  let lastErrorKey = "";
  let lastLogLine = "";

  renderPalette();
  renderAll();

  file.addEventListener("change", async (e)=> {
    const files = [...e.target.files];
    e.target.value = "";
    if(!files.length) return;
    if(busy) return;
    await ingestFiles(files);
  });

  q.addEventListener("input", ()=> renderPlayers());

  btnReset.addEventListener("click", ()=>{
    if(!confirm("全データ（プレイヤー/グループ）を削除します。よろしいですか？")) return;
    state = { players:[], groups:[], color: palette[3], selected:new Set() };
    save(); renderAll();
    setStatus("待機中", false);
    setLog("", false, true);
  });

  btnCreate.addEventListener("click", ()=>{
    const name = $("#groupName").value.trim();
    if(!name) return alert("グループ名を入力してください。");
    const g = { id: Date.now(), name, color: state.color, memberIds: [] };
    state.groups.unshift(g);
    $("#groupName").value = "";
    save();
    renderGroups();
  });

  btnSelectNone.addEventListener("click", ()=>{
    state.selected.clear(); save();
    renderPlayers(); syncButtons();
  });

  btnAssign.addEventListener("click", ()=>{
    if(state.selected.size === 0) return;
    if(state.groups.length === 0) return alert("先にグループを作成してください。");
    openAssignDialog();
  });

  btnClose.addEventListener("click", ()=> closeDialog());

  btnExport.addEventListener("click", async ()=>{
    if(state.groups.length === 0) return;
    const node = document.getElementById("capture");
    const scale = Math.min(2, (window.devicePixelRatio || 1));
    const canvas = await html2canvas(node, { backgroundColor: "#0b0d12", scale });
    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = `groups_${new Date().toISOString().slice(0,10)}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  async function ingestFiles(files){
    setBusy(true);
    beginProgress();
    setStatus(`OCR中…（${files.length}枚）`, true);
    setLog("", true, true);

    for(let i=0;i<files.length;i++){
      setOverall(i, files.length, `画像 ${i+1}/${files.length} を処理中…`);

      const dataUrl = await readAsDataURL(files[i]);

      setSub(0.08, "前処理（2x拡大 + グレースケール）…");
      const pre = await preprocessToDataURL(dataUrl);

      setSub(0.18, "OCR 実行中…");
      let text = "";
      try{
        text = await runOCRMainThread(pre);
      }catch(e){
        const detail = formatErrorDetail(e);
        logErrorOnce("recognize", detail);
        setStatus("OCRに失敗しました（ネットワーク制限の可能性）", false);
        continue;
      }

      setSub(0.92, "抽出（名前 / 戦力）…");
      const extracted = extractPlayersFromText(text);

      addLogLine(`抽出件数: ${extracted.length}\nOCR先頭160文字:\n${text.slice(0,160)}\n---\n`);

      for(const p of extracted){
        const exists = state.players.find(x => x.name === p.name);
        if(exists){
          if(p.power > exists.power){
            exists.power = p.power;
            exists.powerRaw = p.powerRaw;
          }
        }else{
          state.players.push(p);
        }
      }
      state.players.sort((a,b)=> b.power - a.power);
      save(); renderAll();
    }

    setOverall(files.length, files.length, "完了");
    setSub(1, "完了");
    setStatus("完了。", false);
    endProgress();
    setBusy(false);
  }

  async function runOCRMainThread(dataUrl){
    let last = 0;
    const { data } = await Tesseract.recognize(dataUrl, "eng", {
      logger: m => {
        if(m && typeof m.progress === "number"){
          last = Math.max(last, m.progress);
          setSub(0.18 + last*0.74, `OCR 実行中… ${(last*100).toFixed(0)}%`);
        }
      },
      ...OCR_PARAMS
    });
    return data.text || "";
  }

  // ====== Extraction ======
  function extractPlayersFromText(text){
    const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
    const players = [];
    const seen = new Set();
    let unk = 1;

    for(const line of lines){
      const powerMatch = line.match(/(\d{1,4}(?:\.\d{1,2})?)\s*([KMB])/i);
      if(!powerMatch) continue;

      const powerRaw = `${powerMatch[1]}${powerMatch[2].toUpperCase()}`;
      const power = parseCompactNumber(powerRaw);

      let name = line.replace(powerMatch[0], " ").replace(/\s+/g," ").trim();

      // Sanity filter: if OCR spits mostly symbols, mark unknown
      const cleaned = name.replace(/[^A-Za-z0-9_.-]+/g,"");
      const looksBad = cleaned.length < 2 || cleaned.length / Math.max(1, name.length) < 0.45;
      if(looksBad) name = `Unknown ${unk++}`;

      // Dedup
      if(seen.has(name)) continue;
      seen.add(name);

      players.push({
        id: Date.now() + Math.floor(Math.random()*1e6),
        name,
        hq: 0,
        power,
        powerRaw,
        iconDataUrl: ""
      });
    }
    return players;
  }

  function parseCompactNumber(s){
    const m = String(s).toUpperCase().match(/(\d+(?:\.\d+)?)([KMB])/);
    if(!m) return 0;
    const n = parseFloat(m[1]);
    const u = m[2];
    const mult = u === "K" ? 1e3 : u === "M" ? 1e6 : 1e9;
    return Math.round(n * mult);
  }

  function formatCompact(n){
    if(n >= 1e9) return (n/1e9).toFixed(2)+"B";
    if(n >= 1e6) return (n/1e6).toFixed(1)+"M";
    if(n >= 1e3) return (n/1e3).toFixed(1)+"K";
    return String(n);
  }

  // ===== Preprocess: upscale + grayscale (avoid hard threshold) [web:153] =====
  async function preprocessToDataURL(dataUrl){
    const { canvas } = await dataUrlToCanvas(dataUrl);

    const scale = 2;
    const up = document.createElement("canvas");
    up.width = Math.floor(canvas.width * scale);
    up.height = Math.floor(canvas.height * scale);

    const uctx = up.getContext("2d", { willReadFrequently: true });
    uctx.imageSmoothingEnabled = true;
    uctx.imageSmoothingQuality = "high";
    uctx.drawImage(canvas, 0, 0, up.width, up.height);

    const ctx = up.getContext("2d", { willReadFrequently: true });
    const imgData = ctx.getImageData(0,0,up.width,up.height);
    const d = imgData.data;

    for(let i=0;i<d.length;i+=4){
      const gray = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
      d[i]=d[i+1]=d[i+2]=gray;
    }
    ctx.putImageData(imgData,0,0);
    return up.toDataURL("image/png");
  }

  // ===== UI / Render =====
  function renderAll(){ renderPlayers(); renderGroups(); renderCounts(); syncButtons(); }
  function renderCounts(){
    pillCount.textContent = `${state.players.length} 人`;
    pillGroup.textContent = `${state.groups.length} グループ`;
  }

  function renderPlayers(){
    const query = q.value.trim().toLowerCase();
    const list = state.players
      .filter(p => !query || p.name.toLowerCase().includes(query))
      .sort((a,b)=> b.power - a.power);

    if(list.length === 0){
      playerList.innerHTML = `<div class="ghost">プレイヤーがまだいません。スクショを選択してください。</div>`;
      return;
    }

    playerList.innerHTML = list.map(p=>{
      const sel = state.selected.has(p.id) ? "selected" : "";
      return `
        <div class="row ${sel}" data-id="${p.id}">
          <img class="avatar" src="${placeholderAvatar()}" alt="">
          <div class="meta">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="stats">
              <span class="tag">戦力 ${escapeHtml(p.powerRaw || String(p.power))}</span>
            </div>
          </div>
          <div class="power">${formatCompact(p.power)}</div>
        </div>
      `;
    }).join("");

    [...playerList.querySelectorAll(".row")].forEach(el=>{
      el.addEventListener("click", ()=>{
        const id = Number(el.dataset.id);
        if(state.selected.has(id)) state.selected.delete(id);
        else state.selected.add(id);
        save(); renderPlayers(); syncButtons();
      }, { passive:true });
    });
  }

  function renderGroups(){
    if(state.groups.length === 0){
      groupList.innerHTML = `<div class="ghost">グループがまだありません。右上のフォームから作成してください。</div>`;
      btnExport.disabled = true;
      return;
    }

    groupList.innerHTML = state.groups.map(g=>{
      const members = g.memberIds.map(id => state.players.find(p=>p.id===id)).filter(Boolean);
      const total = members.reduce((a,p)=> a + (p.power||0), 0);

      const rows = members
        .sort((a,b)=> b.power - a.power)
        .map(p => `
          <div class="gRow" data-pid="${p.id}" data-gid="${g.id}" title="タップでこのグループから外す">
            <div class="left">
              <div class="nm">${escapeHtml(p.name)}</div>
              <div class="sm">戦力 ${escapeHtml(p.powerRaw)} / ${formatCompact(p.power)}</div>
            </div>
            <div class="pw">${formatCompact(p.power)}</div>
          </div>
        `).join("");

      return `
        <div class="g">
          <div class="gHd">
            <div class="gTitle">
              <span class="dot" style="background:${g.color}"></span>
              <div style="min-width:0">
                <div class="gName">${escapeHtml(g.name)}</div>
                <div class="gSub">${members.length}人 / 合計 ${formatCompact(total)}</div>
              </div>
            </div>
            <button class="btn danger" data-delgid="${g.id}" type="button">削除</button>
          </div>
          <div class="gBd">
            ${rows || `<div class="ghost" style="padding:12px;">メンバーがいません。「選択中を追加…」で入れてください。</div>`}
          </div>
        </div>
      `;
    }).join("");

    // remove member by tapping
    [...groupList.querySelectorAll(".gRow")].forEach(el=>{
      el.addEventListener("click", ()=>{
        const pid = Number(el.dataset.pid);
        const gid = Number(el.dataset.gid);
        const g = state.groups.find(x=>x.id===gid);
        if(!g) return;
        g.memberIds = g.memberIds.filter(x=>x!==pid);
        save(); renderGroups(); syncButtons();
      }, { passive:true });
    });

    // delete group
    [...groupList.querySelectorAll("button[data-delgid]")].forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const gid = Number(btn.dataset.delgid);
        if(!confirm("このグループを削除します。よろしいですか？")) return;
        state.groups = state.groups.filter(x=>x.id!==gid);
        save(); renderGroups(); syncButtons();
      });
    });

    btnExport.disabled = false;
  }

  function syncButtons(){
    btnAssign.disabled = state.selected.size === 0 || state.groups.length === 0;
    btnExport.disabled = state.groups.length === 0;
  }

  // ===== Assign dialog =====
  function openAssignDialog(){
    dlgBody.innerHTML = state.groups.map(g=> `
      <button class="btn primary" style="justify-content:space-between;" data-gid="${g.id}" type="button">
        <span style="display:flex;align-items:center;gap:10px;min-width:0;">
          <span style="width:10px;height:10px;border-radius:999px;background:${g.color};border:1px solid rgba(255,255,255,.25);"></span>
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(g.name)}</span>
        </span>
        <span class="pill">${g.memberIds.length}人</span>
      </button>
    `).join("");

    [...dlgBody.querySelectorAll("button[data-gid]")].forEach(b=>{
      b.addEventListener("click", ()=>{
        const gid = Number(b.dataset.gid);
        addSelectedToGroup(gid);
        closeDialog();
      });
    });

    if (typeof dlg.showModal === "function") dlg.showModal();
    else dlg.setAttribute("open", "");
  }

  function closeDialog(){
    if (typeof dlg.close === "function") dlg.close();
    else dlg.removeAttribute("open");
  }

  function addSelectedToGroup(gid){
    const g = state.groups.find(x=>x.id===gid);
    if(!g) return;
    for(const pid of state.selected){
      if(!g.memberIds.includes(pid)) g.memberIds.push(pid);
    }
    state.selected.clear();
    save(); renderPlayers(); renderGroups(); syncButtons();
  }

  // ===== Palette =====
  function renderPalette(){
    const wrap = $("#colors");
    if(!palette.includes(state.color)) state.color = palette[3];
    wrap.innerHTML = palette.map(c=> `<div class="c ${state.color===c?"sel":""}" style="background:${c}" data-c="${c}"></div>`).join("");
    [...wrap.querySelectorAll(".c")].forEach(el=>{
      el.addEventListener("click", ()=>{ state.color = el.dataset.c; save(); renderPalette(); }, { passive:true });
    });
  }

  // ===== Progress / Status / Log =====
  function setBusy(v){
    busy = v;
    file.disabled = v;
    $("#pickHint").textContent = v ? "処理中…" : "タップして選択";
  }
  function beginProgress(){
    t0 = performance.now();
    progressEl.classList.add("show");
    setOverall(0,1,"準備中…");
    setSub(0,"-");
    if(timerHandle) clearInterval(timerHandle);
    timerHandle = setInterval(()=>{
      const sec = (performance.now() - t0)/1000;
      const now = new Date();
      pTime.textContent = `開始: ${now.toTimeString().slice(0,8)} / 経過: ${sec.toFixed(1)}s`;
    }, 150);
  }
  function endProgress(){
    if(timerHandle){ clearInterval(timerHandle); timerHandle = null; }
  }
  function setOverall(i, n, label){
    const pct = n ? (i/n) : 0;
    pAll.style.width = `${Math.max(0, Math.min(1, pct))*100}%`;
    pLabel.textContent = label;
  }
  function setSub(pct, label){
    const p = Math.max(0, Math.min(1, pct));
    pSub.style.width = `${p*100}%`;
    pSubLabel.textContent = label;
    pSubPct.textContent = `${Math.round(p*100)}%`;
  }
  function setStatus(msg, busyNow){
    statusEl.textContent = msg;
    statusEl.classList.add("show");
    statusEl.style.borderColor = busyNow ? "rgba(207,214,222,.22)" : "rgba(70,230,163,.25)";
  }
  function setLog(msg, show, replace=false){
    if(replace) logEl.textContent = msg;
    else if(msg) logEl.textContent += msg;
    logEl.classList.toggle("show", !!show);
  }
  function addLogLine(line){
    const s = String(line);
    if(s === lastLogLine) return;
    lastLogLine = s;
    setLog(s, true, false);
  }
  function logErrorOnce(tag, detail){
    const key = tag + ":" + String(detail).slice(0, 120);
    if(key === lastErrorKey) return;
    lastErrorKey = key;
    addLogLine(`ERROR(${tag}):\n${detail}\n`);
  }
  function formatErrorDetail(e){
    if(e === undefined) return "undefined";
    if(e === null) return "null";
    if(typeof e === "string") return e;
    try{
      return JSON.stringify({ name:e.name, message:e.message, stack:e.stack }, null, 2);
    }catch(_){
      return String(e);
    }
  }

  // ===== Storage =====
  function save(){
    const plain = { ...state, selected: [...state.selected] };
    localStorage.setItem(LS_KEY, JSON.stringify(plain));
  }
  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    obj.selected = new Set(obj.selected || []);
    return obj;
  }

  // ===== Helpers =====
  function readAsDataURL(f){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=> res(r.result);
      r.onerror = rej;
      r.readAsDataURL(f);
    });
  }
  function dataUrlToCanvas(dataUrl){
    return new Promise((res)=>{
      const img = new Image();
      img.onload = ()=>{
        const c = document.createElement("canvas");
        c.width = img.naturalWidth; c.height = img.naturalHeight;
        c.getContext("2d").drawImage(img,0,0);
        res({ canvas:c });
      };
      img.src = dataUrl;
    });
  }
  function placeholderAvatar(){
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120">
      <rect width="120" height="120" rx="22" fill="#0b0d12"/>
      <circle cx="60" cy="48" r="18" fill="#cfd6de" opacity=".55"/>
      <rect x="28" y="74" width="64" height="26" rx="13" fill="#cfd6de" opacity=".35"/>
    </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
</script>
</body>
</html>
